<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local LLM Benchmark Report</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'bg': 'var(--bg)',
                        'surface': 'var(--surface)',
                        'border': 'var(--border)',
                        'text': 'var(--text)',
                        'muted': 'var(--muted)',
                        'accent': '#f97316',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        serif: ['Georgia', 'Cambria', 'serif'],
                    },
                }
            }
        }
    </script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Charts & Table -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest"></script>

    <style>
        :root {
            --bg: #f5f5f7;
            --surface: #ffffff;
            --border: #d2d2d7;
            --text: #1d1d1f;
            --muted: #86868b;
            --accent: #f97316;
            --accent-light: #fff7ed;
            --success: #34c759;
            --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.05);
            --shadow-hover: 0 4px 12px rgba(0,0,0,0.1), 0 8px 24px rgba(0,0,0,0.08);
            --radius: 16px;
            --radius-sm: 10px;
        }
        .dark {
            --bg: #000000;
            --surface: #1c1c1e;
            --border: #38383a;
            --text: #f5f5f7;
            --muted: #86868b;
            --accent-light: #1a1207;
            --shadow: 0 1px 3px rgba(0,0,0,0.3), 0 4px 12px rgba(0,0,0,0.2);
            --shadow-hover: 0 4px 12px rgba(0,0,0,0.4), 0 8px 24px rgba(0,0,0,0.3);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate { animation: fadeIn 0.4s ease forwards; }
        .delay-1 { animation-delay: 0.05s; opacity: 0; }
        .delay-2 { animation-delay: 0.1s; opacity: 0; }
        .delay-3 { animation-delay: 0.15s; opacity: 0; }
        .delay-4 { animation-delay: 0.2s; opacity: 0; }
        .delay-5 { animation-delay: 0.25s; opacity: 0; }
        .delay-6 { animation-delay: 0.3s; opacity: 0; }
        .delay-7 { animation-delay: 0.35s; opacity: 0; }
        .delay-8 { animation-delay: 0.4s; opacity: 0; }

        /* Card system */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
        }
        .card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        /* Stat values */
        .stat-value {
            font-size: 36px;
            font-weight: 700;
            letter-spacing: -0.02em;
            font-variant-numeric: tabular-nums;
            line-height: 1.1;
        }
        .stat-label {
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--muted);
        }
        .stat-sub {
            font-size: 13px;
            color: var(--muted);
            margin-top: 2px;
        }

        /* DataTable overrides */
        .datatable-wrapper .datatable-search input {
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            font-size: 0.875rem;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .datatable-wrapper .datatable-search input:focus {
            border-color: #f97316;
            box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.15);
        }
        .datatable-wrapper .datatable-top,
        .datatable-wrapper .datatable-bottom {
            padding: 0.75rem 0;
        }
        .datatable-wrapper .datatable-selector {
            padding: 0.5rem 0.625rem;
            border-radius: 0.375rem;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
        }
        .datatable-wrapper .datatable-selector:focus {
            border-color: #f97316;
            box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.15);
            outline: none;
        }
        .datatable-wrapper .datatable-pagination .datatable-pagination-list-item-link {
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            color: var(--text);
            transition: background-color 0.15s;
        }
        .datatable-wrapper .datatable-pagination .datatable-pagination-list-item.datatable-active .datatable-pagination-list-item-link {
            background-color: #f97316;
            color: white;
        }
        .datatable-wrapper .datatable-info {
            color: var(--muted);
        }

        /* Table styling */
        table.dataTable tbody tr {
            transition: background-color 0.15s;
        }
        table.dataTable tbody tr:hover {
            background-color: var(--accent-light);
        }
        table.dataTable th {
            background-color: var(--bg);
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }
        table.dataTable td, table.dataTable th {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
        }
        table.dataTable td {
            color: var(--text);
            font-variant-numeric: tabular-nums;
        }

        /* Select styling */
        select.filter-select {
            padding: 0.375rem 0.5rem;
            font-size: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            background: var(--surface);
            color: var(--text);
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        select.filter-select:focus {
            border-color: #f97316;
            box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.15);
        }
    </style>
</head>
<body class="bg-bg text-text font-sans antialiased transition-colors duration-300">

    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-bg/80 backdrop-blur-md border-b border-border">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 py-2 sm:py-3">
            <div class="flex items-center justify-between">
                <a href="https://eeshans.com" class="text-text hover:text-muted transition-colors font-serif text-base sm:text-lg">
                    <span class="font-normal text-muted">Sidequest by</span> <span class="font-semibold">eeshans.com</span>
                </a>
                <div class="flex items-center gap-2 sm:gap-5">
                    <a href="https://github.com/eeshansrivastava89/local-llm-bench" target="_blank" class="text-muted hover:text-text transition-colors text-sm hidden sm:block">GitHub</a>
                    <a href="https://0to1datascience.substack.com" target="_blank" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs sm:text-sm font-medium bg-[#FF6719] text-white rounded-full hover:bg-[#E55A15] transition-colors">
                        <svg class="h-3 w-3 sm:h-3.5 sm:w-3.5" viewBox="0 0 24 24" fill="currentColor"><path d="M22.539 8.242H1.46V5.406h21.08v2.836zM1.46 10.812V24L12 18.11 22.54 24V10.812H1.46zM22.54 0H1.46v2.836h21.08V0z"></path></svg>
                        Subscribe
                    </a>
                    <button id="themeToggle" class="p-1.5 rounded-md border border-border hover:bg-surface transition-all duration-200" aria-label="Toggle theme">
                        <svg class="w-4 h-4 text-muted dark:block hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        <svg class="w-4 h-4 text-muted dark:hidden block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pt-20">

        <!-- Page Header -->
        <div class="mb-8 animate delay-1">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-amber-400 rounded-xl flex items-center justify-center shadow-lg shadow-orange-500/20">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-text">Local LLM Benchmark Report</h1>
                        <p class="text-sm text-muted">Local inference performance analysis</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-surface border border-border text-text shadow-sm">
                        {{ total_runs }} runs
                    </span>
                </div>
            </div>

            <!-- System Info Bar -->
            <div class="card animate delay-2 mb-4">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                        <p class="text-muted text-xs uppercase tracking-wide mb-1">System</p>
                        <p class="text-text font-medium">{{ os_version }}</p>
                    </div>
                    <div>
                        <p class="text-muted text-xs uppercase tracking-wide mb-1">CPU</p>
                        <p class="text-text font-medium">{{ cpu }}</p>
                    </div>
                    <div>
                        <p class="text-muted text-xs uppercase tracking-wide mb-1">RAM</p>
                        <p class="text-text font-medium">{{ ram_gb }} GB</p>
                    </div>
                    <div>
                        <p class="text-muted text-xs uppercase tracking-wide mb-1">GPU</p>
                        <p class="text-text font-medium">{{ gpu }}</p>
                    </div>
                </div>
            </div>

            <!-- Meta info row -->
            <div class="flex flex-wrap items-center gap-x-6 gap-y-2 text-sm text-muted">
                <span class="flex items-center gap-1.5">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Last run: {{ last_run }}
                </span>
                <span class="flex items-center gap-1.5">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                    Models tested: {{ models_tested }}
                </span>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="card animate delay-3">
                <p class="stat-label">Total Runs</p>
                <p class="stat-value mt-2" style="color: #f97316;">{{ total_runs }}</p>
            </div>
            <div class="card animate delay-4">
                <p class="stat-label">Best Avg F1</p>
                <p class="stat-value mt-2" style="color: #34c759;">{{ best_f1 }}%</p>
                <p class="stat-sub">{{ best_f1_model }}</p>
            </div>
            <div class="card animate delay-5">
                <p class="stat-label">Fastest Avg</p>
                <p class="stat-value mt-2" style="color: #06b6d4;">{{ fastest_time }}s</p>
                <p class="stat-sub">{{ fastest_model }}</p>
            </div>
            <div class="card animate delay-6">
                <p class="stat-label">Lowest Avg Memory</p>
                <p class="stat-value mt-2" style="color: #8b5cf6;">{{ lowest_memory }} GB</p>
                <p class="stat-sub">{{ lowest_memory_model }}</p>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- F1 Score Ranking -->
            <div class="card animate delay-7" style="padding: 24px;">
                <div class="mb-2">
                    <h2 class="text-lg font-semibold text-text">Composite Score by Model</h2>
                    <p class="text-xs text-muted mt-1">F1 &times; speed<sup>0.3</sup> &times; confidence &middot; higher is better</p>
                </div>
                <div id="f1-bar-chart" style="height: 320px;"></div>
            </div>

            <!-- Speed vs Quality Bubble -->
            <div class="card animate delay-8" style="padding: 24px;">
                <div class="mb-2">
                    <h2 class="text-lg font-semibold text-text">Speed vs Quality</h2>
                    <p class="text-xs text-muted mt-1">Bubble size = memory &middot; top-left is ideal</p>
                </div>
                <div id="bubble-chart" style="height: 320px;"></div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Metrics Over Time -->
            <div class="card animate delay-7" style="padding: 24px;">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-lg font-semibold text-text">Metrics Over Time</h2>
                </div>
                <div class="flex flex-wrap items-center gap-3 mb-4">
                    <div class="flex items-center gap-1.5">
                        <label for="metric-select" class="text-xs font-medium text-muted">Metric:</label>
                        <select id="metric-select" onchange="updateTimeChart()" class="filter-select w-28">
                            <option value="f1">F1 Score</option>
                            <option value="time_sec">Time (s)</option>
                            <option value="memory_delta_gb">Memory (GB)</option>
                            <option value="tokens">Tokens</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <label for="model-select" class="text-xs font-medium text-muted">Model:</label>
                        <select id="model-select" onchange="updateTimeChart()" class="filter-select w-28">
                            <option value="all">All</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <label for="prompt-select" class="text-xs font-medium text-muted">Prompt:</label>
                        <select id="prompt-select" onchange="updateTimeChart()" class="filter-select w-24 font-mono">
                            <option value="all">All</option>
                        </select>
                    </div>
                </div>
                <div id="time-chart" style="height: 280px;"></div>
            </div>

            <!-- Resource Usage -->
            <div class="card animate delay-8" style="padding: 24px;">
                <div class="mb-2">
                    <h2 class="text-lg font-semibold text-text">Resource Usage</h2>
                    <p class="text-xs text-muted mt-1">Average time &amp; memory per model</p>
                </div>
                <div id="resource-chart" style="height: 320px;"></div>
            </div>
        </div>

        <!-- Results Table -->
        <div class="card animate delay-8" style="padding: 24px;">
            <h2 class="text-lg font-semibold text-text mb-4">All Results</h2>
            <div class="overflow-x-auto">
                <table id="results-table" class="w-full">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Model</th>
                            <th>Backend</th>
                            <th>Time (s)</th>
                            <th>Memory (GB)</th>
                            <th>Tokens</th>
                            <th>F1</th>
                            <th>Composite</th>
                            <th>Precision</th>
                            <th>Recall</th>
                            <th>Prompt</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <footer class="border-t border-border mt-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-6">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4 text-xs text-muted">
                <p>&copy; 2026 Eeshan Srivastava. All rights reserved.</p>
                <p class="italic">Personal project &middot; MIT License &middot; Non-commercial</p>
                <div class="flex items-center gap-4">
                    <a href="https://github.com/eeshansrivastava89/local-llm-bench" target="_blank" class="hover:text-text transition-colors flex items-center gap-1.5">
                        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                        Source
                    </a>
                    <a href="https://www.linkedin.com/in/eeshans/" target="_blank" class="hover:text-text transition-colors">
                        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.06 2.06 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0z"/></svg>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;
        if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            html.classList.add('dark');
        }
        themeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light');
            renderAllCharts();
        });

        const data = {{ data_json | safe }};

        // Get unique models and prompts
        const models = [...new Set(data.map(d => d.model_name))];
        const prompts = [...new Set(data.map(d => d.prompt_hash).filter(h => h))];

        // Populate model selector
        const modelSelect = document.getElementById('model-select');
        models.forEach(model => {
            const opt = document.createElement('option');
            opt.value = model;
            opt.textContent = model;
            modelSelect.appendChild(opt);
        });

        // Populate prompt selector
        const promptSelect = document.getElementById('prompt-select');
        prompts.forEach((hash) => {
            const opt = document.createElement('option');
            opt.value = hash;
            opt.textContent = hash.substring(0, 8);
            promptSelect.appendChild(opt);
        });

        // Color palette — warm-first
        const colors = ['#f97316', '#06b6d4', '#8b5cf6', '#34c759', '#f43f5e', '#fb923c', '#ec4899', '#14b8a6', '#eab308', '#6366f1'];
        const modelColors = {};
        models.forEach((m, i) => modelColors[m] = colors[i % colors.length]);

        // Pre-compute composite scores per model for table
        const _modelRuns = {};
        data.forEach(r => {
            if (!r.success || !r.model_name) return;
            if (!_modelRuns[r.model_name]) _modelRuns[r.model_name] = { f1s: [], times: [] };
            _modelRuns[r.model_name].f1s.push(r.f1 || 0);
            _modelRuns[r.model_name].times.push(r.time_sec || 0);
        });
        const _minTime = Math.min(...Object.values(_modelRuns).map(v => v.times.reduce((a, b) => a + b, 0) / v.times.length));
        const _K = 10;
        const compositeByModel = {};
        Object.entries(_modelRuns).forEach(([model, v]) => {
            const avgF1 = v.f1s.reduce((a, b) => a + b, 0) / v.f1s.length * 100;
            const avgTime = v.times.reduce((a, b) => a + b, 0) / v.times.length;
            const speedFactor = Math.pow(_minTime / avgTime, 0.3);
            const confidence = Math.min(1, v.f1s.length / _K);
            compositeByModel[model] = +(avgF1 * speedFactor * confidence).toFixed(1);
        });

        // Populate table
        const tbody = document.getElementById('table-body');
        data.forEach(row => {
            const tr = document.createElement('tr');
            const ts = row.timestamp ? row.timestamp.substring(0, 19).replace('T', ' ') : '-';
            const f1 = row.f1 ? (row.f1 * 100).toFixed(1) + '%' : '-';
            const prec = row.precision ? (row.precision * 100).toFixed(1) + '%' : '-';
            const rec = row.recall ? (row.recall * 100).toFixed(1) + '%' : '-';
            const statusClass = row.success ? 'text-emerald-500' : 'text-red-500';
            const statusIcon = row.success ? '&#10003;' : '&#10007;';
            const promptShort = row.prompt_hash ? row.prompt_hash.substring(0, 8) : '-';

            tr.innerHTML = `
                <td class="text-muted">${ts}</td>
                <td class="font-medium">${row.model_name || '-'}</td>
                <td><span class="px-2 py-0.5 text-xs font-medium rounded-full ${row.backend === 'mlx' ? 'bg-orange-500/15 text-orange-500' : 'bg-violet-500/15 text-violet-400'}">${row.backend || '-'}</span></td>
                <td>${row.time_sec ? row.time_sec.toFixed(1) : '-'}</td>
                <td>${row.memory_delta_gb ? row.memory_delta_gb.toFixed(2) : '-'}</td>
                <td>${row.tokens || '-'}</td>
                <td class="font-medium">${f1}</td>
                <td class="font-medium">${compositeByModel[row.model_name] ?? '-'}</td>
                <td>${prec}</td>
                <td>${rec}</td>
                <td><code class="text-xs bg-bg px-1.5 py-0.5 rounded border border-border">${promptShort}</code></td>
                <td class="${statusClass} font-bold text-base">${statusIcon}</td>
            `;
            tbody.appendChild(tr);
        });

        // Initialize DataTable
        const dataTable = new simpleDatatables.DataTable("#results-table", {
            searchable: true,
            sortable: true,
            perPage: 25,
            columns: [
                { select: 0, sort: "desc" }
            ]
        });

        // ── Shared helpers ──

        function getPlotlyColors() {
            const isDark = document.documentElement.classList.contains('dark');
            return {
                bg: 'transparent',
                text: isDark ? '#f5f5f7' : '#1d1d1f',
                muted: '#86868b',
                grid: isDark ? '#2c2c2e' : '#f0f0f2',
                line: isDark ? '#38383a' : '#d2d2d7'
            };
        }

        function baseLayout() {
            const c = getPlotlyColors();
            return {
                font: { family: 'Inter, system-ui, sans-serif', size: 12, color: c.text },
                paper_bgcolor: c.bg,
                plot_bgcolor: c.bg,
                hoverlabel: { font: { family: 'Inter, system-ui, sans-serif', size: 12 } },
                transition: { duration: 350, easing: 'cubic-in-out' }
            };
        }

        const plotlyConfig = { responsive: true, displayModeBar: false };

        // Compute model averages (shared across charts)
        function getModelAverages() {
            const stats = {};
            models.forEach(model => {
                const d = data.filter(r => r.model_name === model && r.success);
                if (!d.length) return;
                stats[model] = {
                    avgF1: d.reduce((s, r) => s + (r.f1 || 0), 0) / d.length,
                    avgTime: d.reduce((s, r) => s + (r.time_sec || 0), 0) / d.length,
                    avgMemory: d.reduce((s, r) => s + (r.memory_delta_gb || 0), 0) / d.length,
                    runs: d.length
                };
            });
            return stats;
        }

        // Shorten long model names for axis labels
        function shortName(name) {
            if (!name) return '-';
            // Remove common prefixes
            let s = name.replace(/^(mlx\/mlx-community\/|ollama\/|mlx\/)/, '');
            // Truncate if still long
            return s.length > 28 ? s.substring(0, 26) + '…' : s;
        }

        // ── Chart 1: Composite Score Ranking (horizontal bar) ──
        // Composite = F1 × speed_factor^0.3 × confidence_factor
        //   speed_factor = min_time / model_time (fastest = 1.0)
        //   confidence_factor = min(1, runs / K) where K = 5

        function getCompositeScores() {
            const stats = getModelAverages();
            const entries = Object.entries(stats).filter(([, v]) => v.avgF1 > 0);
            const minTime = Math.min(...entries.map(([, v]) => v.avgTime));
            const K = 10;

            const scores = {};
            entries.forEach(([model, v]) => {
                const f1 = v.avgF1 * 100;
                const speedFactor = Math.pow(minTime / v.avgTime, 0.3);
                const confidence = Math.min(1, v.runs / K);
                scores[model] = {
                    composite: +(f1 * speedFactor * confidence).toFixed(1),
                    f1: +f1.toFixed(1),
                    speedFactor: +speedFactor.toFixed(2),
                    confidence: +confidence.toFixed(2),
                    runs: v.runs,
                    avgTime: +v.avgTime.toFixed(1)
                };
            });
            return scores;
        }

        function renderF1BarChart() {
            const c = getPlotlyColors();
            const scores = getCompositeScores();
            const sorted = Object.entries(scores)
                .sort((a, b) => a[1].composite - b[1].composite); // ascending for horizontal bar (bottom = best)

            const names = sorted.map(([m]) => shortName(m));
            const values = sorted.map(([, v]) => v.composite);
            const fullNames = sorted.map(([m]) => m);
            const barColors = sorted.map(([m]) => modelColors[m]);

            const trace = {
                y: names,
                x: values,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: barColors,
                    line: { width: 0 },
                    cornerradius: 4
                },
                text: values.map(v => v.toFixed(1)),
                textposition: 'outside',
                textfont: { size: 11, color: c.text },
                hovertemplate: fullNames.map((m, i) => {
                    const s = scores[m];
                    return `<b>${m}</b><br>Composite: ${s.composite}<br>F1: ${s.f1}% &times; Speed: ${s.speedFactor} &times; Conf: ${s.confidence}<br>Avg time: ${s.avgTime}s &middot; Runs: ${s.runs}<extra></extra>`;
                }),
                cliponaxis: false
            };

            const layout = {
                ...baseLayout(),
                margin: { t: 8, b: 20, l: 180, r: 60 },
                xaxis: {
                    range: [0, Math.max(...values) * 1.15],
                    showgrid: true,
                    gridcolor: c.grid,
                    zeroline: false,
                    tickfont: { size: 11, color: c.muted }
                },
                yaxis: {
                    tickfont: { size: 11, color: c.text },
                    automargin: true
                },
                bargap: 0.25
            };

            Plotly.newPlot('f1-bar-chart', [trace], layout, plotlyConfig);
        }

        // ── Chart 2: Speed vs Quality Bubble ──

        function renderBubbleChart() {
            const c = getPlotlyColors();
            const stats = getModelAverages();
            const active = models.filter(m => stats[m]);

            // Scale bubble sizes relative to max memory
            const memValues = active.map(m => stats[m].avgMemory || 0.5);
            const maxMem = Math.max(...memValues, 1);

            const trace = {
                x: active.map(m => stats[m].avgTime),
                y: active.map(m => stats[m].avgF1 * 100),
                text: active.map(m => shortName(m)),
                mode: 'markers+text',
                textposition: 'top center',
                textfont: { size: 9, color: c.muted },
                marker: {
                    size: active.map(m => {
                        const norm = (stats[m].avgMemory || 0.5) / maxMem;
                        return 18 + norm * 40;
                    }),
                    color: active.map(m => modelColors[m]),
                    opacity: 0.85,
                    line: { width: 2, color: c.grid }
                },
                hovertemplate: active.map(m => {
                    const s = stats[m];
                    return `<b>${m}</b><br>Time: ${s.avgTime.toFixed(1)}s<br>F1: ${(s.avgF1 * 100).toFixed(1)}%<br>Memory: ${s.avgMemory.toFixed(2)} GB<br>Runs: ${s.runs}<extra></extra>`;
                }),
                showlegend: false
            };

            const times = active.map(m => stats[m].avgTime);
            const maxTime = Math.max(...times, 1) * 1.2;

            const layout = {
                ...baseLayout(),
                margin: { t: 16, b: 44, l: 50, r: 16 },
                xaxis: {
                    title: { text: 'Avg Time (s)', font: { size: 11, color: c.muted }, standoff: 8 },
                    range: [0, maxTime],
                    zeroline: false,
                    showgrid: true,
                    gridcolor: c.grid,
                    tickfont: { size: 11, color: c.muted }
                },
                yaxis: {
                    title: { text: 'Avg F1 (%)', font: { size: 11, color: c.muted }, standoff: 8 },
                    range: [Math.max(0, Math.min(...active.map(m => stats[m].avgF1 * 100)) - 10), 108],
                    showgrid: true,
                    gridcolor: c.grid,
                    tickfont: { size: 11, color: c.muted }
                },
                hovermode: 'closest'
            };

            Plotly.newPlot('bubble-chart', [trace], layout, plotlyConfig);
        }

        // ── Chart 3: Metrics Over Time ──

        function updateTimeChart() {
            const metric = document.getElementById('metric-select').value;
            const selectedModel = document.getElementById('model-select').value;
            const selectedPrompt = document.getElementById('prompt-select').value;
            const c = getPlotlyColors();

            const metricLabels = {
                'f1': 'F1 Score (%)',
                'time_sec': 'Time (s)',
                'memory_delta_gb': 'Memory (GB)',
                'tokens': 'Total Tokens'
            };

            let filtered = data;
            if (selectedPrompt !== 'all') {
                filtered = data.filter(d => d.prompt_hash === selectedPrompt);
            }

            const traces = [];
            const targetModels = selectedModel === 'all' ? models : [selectedModel];

            targetModels.forEach(model => {
                const md = filtered.filter(d => d.model_name === model && d.success);
                if (!md.length) return;

                traces.push({
                    x: md.map(d => d.timestamp),
                    y: md.map(d => metric === 'f1' ? (d[metric] || 0) * 100 : d[metric]),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: shortName(model),
                    line: { color: modelColors[model], width: 2.5, shape: 'spline' },
                    marker: { size: 6, color: modelColors[model] },
                    hovertemplate: `<b>${model}</b><br>%{x|%b %d}<br>${metricLabels[metric]}: %{y:.1f}<extra></extra>`
                });
            });

            const layout = {
                ...baseLayout(),
                margin: { t: 8, b: 64, l: 48, r: 12 },
                xaxis: {
                    tickangle: -40,
                    showgrid: false,
                    linecolor: c.line,
                    tickfont: { size: 10, color: c.muted },
                    type: 'date'
                },
                yaxis: {
                    title: { text: metricLabels[metric], font: { size: 11, color: c.muted }, standoff: 4 },
                    rangemode: 'tozero',
                    showgrid: true,
                    gridcolor: c.grid,
                    zeroline: false,
                    tickfont: { size: 11, color: c.muted }
                },
                legend: {
                    orientation: 'h',
                    y: -0.38,
                    x: 0.5,
                    xanchor: 'center',
                    font: { size: 10, color: c.muted },
                    bgcolor: 'transparent'
                },
                hovermode: 'x unified'
            };

            Plotly.newPlot('time-chart', traces, layout, plotlyConfig);
        }

        // ── Chart 4: Resource Usage (grouped bar) ──

        function renderResourceChart() {
            const c = getPlotlyColors();
            const stats = getModelAverages();
            const sorted = Object.entries(stats)
                .sort((a, b) => a[1].avgTime - b[1].avgTime); // fastest first

            const names = sorted.map(([m]) => shortName(m));
            const fullNames = sorted.map(([m]) => m);

            const timeTrace = {
                x: names,
                y: sorted.map(([, v]) => +v.avgTime.toFixed(1)),
                name: 'Time (s)',
                type: 'bar',
                marker: { color: '#06b6d4', cornerradius: 3 },
                hovertemplate: fullNames.map((m, i) =>
                    `<b>${m}</b><br>Avg Time: ${sorted[i][1].avgTime.toFixed(1)}s<extra></extra>`
                )
            };

            const memTrace = {
                x: names,
                y: sorted.map(([, v]) => +v.avgMemory.toFixed(2)),
                name: 'Memory (GB)',
                type: 'bar',
                marker: { color: '#8b5cf6', cornerradius: 3 },
                hovertemplate: fullNames.map((m, i) =>
                    `<b>${m}</b><br>Avg Memory: ${sorted[i][1].avgMemory.toFixed(2)} GB<extra></extra>`
                )
            };

            const layout = {
                ...baseLayout(),
                barmode: 'group',
                bargap: 0.25,
                bargroupgap: 0.08,
                margin: { t: 8, b: 100, l: 48, r: 12 },
                xaxis: {
                    tickangle: -40,
                    tickfont: { size: 10, color: c.muted },
                    automargin: true
                },
                yaxis: {
                    showgrid: true,
                    gridcolor: c.grid,
                    zeroline: false,
                    tickfont: { size: 11, color: c.muted }
                },
                legend: {
                    orientation: 'h',
                    y: 1.06,
                    x: 0.5,
                    xanchor: 'center',
                    font: { size: 11, color: c.text },
                    bgcolor: 'transparent'
                }
            };

            Plotly.newPlot('resource-chart', [timeTrace, memTrace], layout, plotlyConfig);
        }

        // ── Render all ──

        function renderAllCharts() {
            renderF1BarChart();
            renderBubbleChart();
            updateTimeChart();
            renderResourceChart();
        }

        renderAllCharts();
    </script>
</body>
</html>
